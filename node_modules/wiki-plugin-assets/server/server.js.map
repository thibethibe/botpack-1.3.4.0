{
  "version": 3,
  "names": [
    "async",
    "basename",
    "cors",
    "formidable",
    "fs",
    "mkdirp",
    "startServer",
    "require",
    "_require",
    "req",
    "res",
    "next",
    "header",
    "params",
    "app",
    "argv",
    "get",
    "assets",
    "isFile",
    "path",
    "query",
    "match",
    "concat",
    "name",
    "done",
    "stat",
    "error",
    "stats",
    "readdir",
    "names",
    "json",
    "filter",
    "files",
    "post",
    "form",
    "securityhandler",
    "isAuthorized",
    "status",
    "send",
    "IncomingForm",
    "multiples",
    "uploadDir",
    "sync",
    "on",
    "value",
    "field",
    "file",
    "rename",
    "err",
    "console",
    "log",
    "end",
    "parse",
    "ref",
    "ref1",
    "ref2",
    "ref3",
    "toRemove",
    "session",
    "passport",
    "user",
    "email",
    "friend",
    "unlink",
    "message",
    "module",
    "exports"
  ],
  "sources": [
    "server.coffee"
  ],
  "sourcesContent": [
    "# assets plugin, server-side component\n# These handlers are launched with the wiki server. \n\nfs = require 'fs'\n{ basename } = require 'path'\nmkdirp = require 'mkdirp'\nasync = require 'async'\nformidable = require 'formidable'\n\ncors = (req, res, next) ->\n  res.header('Access-Control-Allow-Origin', '*')\n  next()\n\nstartServer = (params) ->\n  app = params.app\n  argv = params.argv\n\n  app.get '/plugin/assets/list', cors, (req, res) ->\n    assets = (req.query.assets||'').match(/([\\w\\/-]*)/)[1]\n    path = \"#{argv.assets}/#{assets}\"\n    isFile = (name, done) ->\n      return done false if name.match /^\\./\n      fs.stat \"#{path}/#{name}\", (error, stats) ->\n        return done error if error\n        return done null, stats.isFile()\n    fs.readdir path, (error, names) ->\n      return res.json {error} if error\n      async.filter names, isFile, (error, files) ->\n        return res.json {error, files}\n\n  app.post '/plugin/assets/upload', (req, res) ->\n    return res.status(401).send(\"must be logged in owner\") unless app.securityhandler.isAuthorized(req)\n    form = new (formidable.IncomingForm)\n    form.multiples = true\n    form.uploadDir = \"#{argv.assets}\"\n    mkdirp.sync form.uploadDir\n    form.on 'field', (name, value) ->\n      return unless name == 'assets'\n      assets = (value||'').match(/([\\w\\/-]*)/)[1]\n      form.uploadDir = \"#{argv.assets}/#{assets}\"\n      mkdirp.sync form.uploadDir\n    form.on 'file', (field, file) ->\n      fs.rename file.path, \"#{form.uploadDir}/#{file.name}\", (err) ->\n        return res.status(500).send(\"rename error: #{err}\") if err\n    form.on 'error', (err) ->\n      console.log \"upload error: #{err}\"\n      res.status(500).send(\"upload error: #{err}\")\n    form.on 'end', ->\n      res.end 'success'\n    form.parse req\n\n  app.post '/plugin/assets/delete', (req, res) ->\n    return res.status(401).send(\"must login\") unless req.session?.passport?.user || req.session?.email || req.session?.friend\n    file = basename(req.query.file||'')\n    assets = (req.query.assets||'').match(/([\\w\\/-]*)/)[1]\n    toRemove = \"#{argv.assets}/#{assets}/#{file}\"\n    fs.unlink toRemove, (err) ->\n      return res.status(500).send(err.message) if err\n      res.status(200).send('ok')\n\nmodule.exports = {startServer}\n"
  ],
  "mappings": "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"
}