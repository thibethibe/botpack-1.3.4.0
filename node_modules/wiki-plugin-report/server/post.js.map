{
  "version": 3,
  "names": [
    "Farm",
    "Port",
    "Site",
    "Sufix",
    "child",
    "compose",
    "enclose",
    "fetchPage",
    "findPaths",
    "findPubs",
    "findSchedule",
    "flow",
    "fold",
    "fs",
    "header",
    "links",
    "print",
    "ready",
    "report",
    "sendmail",
    "require",
    "_console",
    "console",
    "log",
    "apply",
    "arguments",
    "process",
    "env",
    "done",
    "exec",
    "concat",
    "err",
    "stdout",
    "stderr",
    "i",
    "len",
    "path",
    "ref",
    "results",
    "site",
    "slug",
    "x",
    "split",
    "length",
    "reverse",
    "_path$split$reverse2",
    "_slicedToArray",
    "_path$split$reverse",
    "_path$split$reverse4",
    "_path$split$reverse3",
    "text",
    "readFile",
    "JSON",
    "parse",
    "page",
    "item",
    "story",
    "type",
    "issue",
    "schedule",
    "interval",
    "recipients",
    "replace",
    "match",
    "join",
    "since",
    "action",
    "active",
    "j",
    "len1",
    "ref1",
    "result",
    "journal",
    "date",
    "id",
    "push",
    "_ref",
    "now",
    "period",
    "lapse",
    "thisIssue",
    "window",
    "advance",
    "getTime",
    "fields",
    "k",
    "v",
    "_ref2",
    "summary",
    "To",
    "Subject",
    "title",
    "pub",
    "output",
    "send",
    "spawn",
    "stdin",
    "write",
    "message",
    "end",
    "setEncoding",
    "on",
    "data",
    "code",
    "Date"
  ],
  "sources": [
    "post.coffee"
  ],
  "sourcesContent": [
    "child = require 'child_process'\nfs = require 'fs'\nreport = require './report.js'\nprint = (arg...) -> console.log arg...\n\n\n\n# 0 * * * * (cd wiki/client/plugins/report; Port=:1111 /usr/local/bin/node post.js)\n\nSite = process.env.Site or null\nPort = process.env.Port or ''\nFarm = process.env.Farm or '../../../data/farm' unless Site\nSufix = process.env.Sufix or 'report'\n\n\n\n# Fetch data from wiki farm files\n\nfindPaths = (done) ->\n  if Farm\n    child.exec \"ls #{Farm}/*/pages/*-#{Sufix}\", (err, stdout, stderr) ->\n      for path in stdout.split /\\n/\n        continue if path is ''\n        [slug,x,site] = path.split('/').reverse()\n        done path, site, slug\n  else\n    child.exec \"ls ../../../data/pages/*-#{Sufix}\", (err, stdout, stderr) ->\n      for path in stdout.split /\\n/\n        continue if path is ''\n        [slug] = path.split('/').reverse()\n        done path, Site, slug\n\nfetchPage = (path, done) ->\n  text = fs.readFile path, 'utf8', (err, text) ->\n    return console.log ['fetchPage', path, err] if err\n    done JSON.parse text\n\nfindSchedule = (page) ->\n  for item in page.story\n    return report.parse(item.text) if item.type is 'report'\n  null\n\nfindPubs = (done) ->\n  findPaths (path, site, slug) ->\n    fetchPage path, (page) ->\n      if schedule = findSchedule page\n        for issue in schedule\n          if issue.interval? and issue.recipients?.length\n            done {site, slug, page, schedule, issue}\n\n\n\n# Compose summary from story and journal\n\nlinks = (text) ->\n  text.replace /\\[(http.*?) +(.*?)\\]/gi, \"[$2]\"\n\nflow = (text) ->\n  text.replace(/\\s+/g, ' ') + \"\\n\"\n\nfold = (text) ->\n  # http://james.padolsey.com/javascript/wordwrap-for-javascript/\n  text.match(/.{1,50}(\\s|$)|\\S+?(\\s|$)/g).join \"\\n\"\n\ncompose = (page, since) ->\n  active = {}\n  for action in page.journal\n    if action.date and action.date > since\n      active[action.id] = 'NEW' if action.type == 'add'\n      active[action.id] = 'UPDATE' if action.type == 'edit' and not active[action.id]\n  result = []\n  for item in page.story\n    if item.type is 'paragraph' and active[item.id]\n      result.push active[item.id]\n      result.push fold flow links item.text\n  result.join \"\\n\"\n\nready = ({issue, now, period}) ->\n  window = period*60*1000\n  thisIssue = report.advance(now, issue, 0)\n  lapse = now.getTime() - thisIssue.getTime()\n  lapse < window\n\n\n\n# Hand off to sendmail for distribution\n\nheader = (fields) ->\n  (\"#{k}: #{v}\" for k, v of fields).join \"\\n\"\n\nenclose = ({site, slug, page, issue, summary}) ->\n  [header\n    To: issue.recipients.join \", \"\n    'Reply-to': issue.recipients.join \", \"\n    Subject: \"#{page.title} (#{issue.interval})\"\n  \"#{page.title}\\nPublished #{issue.interval} from Federated Wiki\"\n  summary\n  \"See details at\\nhttp://#{site}#{Port}/#{slug}.html\"].join \"\\n\\n\"\n\nsendmail = (pub) ->\n  output = []\n  send = child.spawn '/usr/sbin/sendmail', ['-fward@wiki.org', '-t']\n  send.stdin.write pub.message\n  send.stdin.end()\n  send.stderr.setEncoding 'utf8'\n  send.stderr.on 'data', (data) -> output.push data\n  send.on 'exit', (code) ->\n    print \"sent #{pub.page.title} (#{pub.issue.interval}), code: #{code}\"\n    print output.join ''\n\n\n\n# Main program loops over all publications\n\nfindPubs (pub) ->\n  pub.now = new Date(2012,12-1,21,0,0,3)\n  pub.now = new Date()\n  pub.period = 60\n  if ready pub\n    pub.summary = compose pub.page, report.advance(pub.now, pub.issue, -1)\n    unless pub.summary is ''\n      pub.message = enclose pub\n      sendmail pub\n"
  ],
  "mappings": "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"
}